<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Share</title>
    <script async defer src="https://maps.google.com/maps/api/js?key=AIzaSyCtk-cv518k28_YbwytXpeu3-DAg92mAA4&libraries=maps,marker&callback=checkSession"></script>
    <link rel="icon" type="image/x-icon" href="/location-share-test/favicon.ico">
    <style>
        #map { height: 400px; width: 100%; }
        #event-creation { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Location Share</h1>
    <div id="event-creation">
        <button id="createEventBtn">Create New Event</button>
        <p id="share-link" style="display: none;">Share this link: <a href="#" id="link"></a></p>
    </div>
    <div id="map"></div>

    <script>
        let map, markers = [], sessionId, userName, shareUntil, creatorName;

        function checkSession() {
            const urlParams = new URLSearchParams(window.location.search);
            sessionId = urlParams.get('session');
            if (sessionId) {
                fetchSessionCreator();
            } else {
                console.log("No session ID, waiting for event creation");
            }
        }

        function fetchSessionCreator() {
            fetch(`https://location-share-backend-rubin-gosaliyas-projects.vercel.app/getSession?sessionId=${sessionId}`)
                .then(response => {
                    if (!response.ok) throw new Error(`Failed to fetch session: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    creatorName = data.creatorName;
                    console.log("Session creator:", creatorName);
                    initMap();
                })
                .catch(error => {
                    console.error("Error fetching session:", error.message);
                    initMap(); // Proceed even if fetch fails
                });
        }

        function createEvent() {
            const duration = prompt("How long should this event last (hours, e.g., 2.5)?");
            if (!duration || isNaN(duration) || duration <= 0 || duration > 24) {
                alert("Please enter a valid duration between 0 and 24 hours");
                return;
            }
            creatorName = prompt("Please enter your name:") || "Anonymous";
            console.log("Creating event with duration:", duration, "Creator:", creatorName);
            fetch(`https://location-share-backend-rubin-gosaliyas-projects.vercel.app/createEvent?duration=${duration}&creatorName=${encodeURIComponent(creatorName)}`)
                .then(response => {
                    if (!response.ok) throw new Error(`Failed to create event: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    sessionId = data.sessionId;
                    console.log("Event created:", data);
                    document.getElementById('share-link').style.display = 'block';
                    const linkElement = document.getElementById('link');
                    linkElement.href = data.shareLink;
                    linkElement.textContent = data.shareLink;
                    userName = creatorName;
                    const shareDuration = prompt("How long do you want to share your location (hours, e.g., 1.5)?");
                    if (!shareDuration || isNaN(shareDuration) || shareDuration <= 0) {
                        alert("Please enter a valid sharing duration");
                        return;
                    }
                    shareUntil = Date.now() + parseFloat(shareDuration) * 3600000;
                    console.log("Creator:", creatorName, "Sharing until:", new Date(shareUntil));
                    initMap();
                })
                .catch(error => console.error('Error creating event:', error.message));
        }

        document.getElementById('createEventBtn').addEventListener('click', createEvent);

        function initMap() {
            console.log("initMap: Session ID:", sessionId || "None (static mode)");

            if (!userName) { // Prompt only if not set (i.e., not creator yet)
                userName = prompt("Please enter your name:") || "Anonymous";
                const shareDuration = prompt("How long do you want to share your location (hours, e.g., 1.5)?");
                if (!shareDuration || isNaN(shareDuration) || shareDuration <= 0) {
                    alert("Please enter a valid sharing duration");
                    return;
                }
                shareUntil = Date.now() + parseFloat(shareDuration) * 3600000;
                console.log("User:", userName, "Sharing until:", new Date(shareUntil));
            }

            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 0, lng: 0 },
                zoom: 2,
                mapId: 'aa476a0fd363ab03'
            });

            function setMapToUserLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            map.setCenter({ lat: position.coords.latitude, lng: position.coords.longitude });
                            map.setZoom(15);
                        },
                        error => console.error("Geolocation error:", error.message)
                    );
                }
            }

            function sendLocation() {
                if (Date.now() > shareUntil) {
                    console.log("sendLocation: Sharing expired for", userName);
                    return;
                }
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            const payload = {
                                sessionId: sessionId || null,
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                userName,
                                shareUntil,
                                accuracy: position.coords.accuracy
                            };
                            console.log("sendLocation: Sending:", payload, "Accuracy:", position.coords.accuracy);
                            fetch('https://location-share-backend-rubin-gosaliyas-projects.vercel.app/updateLocation', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            })
                            .then(response => {
                                if (!response.ok) throw new Error(`Update failed: ${response.status}`);
                                return response.text();
                            })
                            .then(data => console.log("sendLocation: Response:", data))
                            .catch(error => console.error("sendLocation: Error:", error.message));
                        },
                        error => console.error("sendLocation: Geolocation error:", error.message)
                    );
                }
            }

            function updateMap() {
                const url = sessionId
                    ? `https://location-share-backend-rubin-gosaliyas-projects.vercel.app/getLocations?sessionId=${sessionId}`
                    : `https://location-share-backend-rubin-gosaliyas-projects.vercel.app/getLocations?userName=${encodeURIComponent(userName)}`;
                console.log("updateMap: Fetching from:", url);
                fetch(url)
                    .then(response => {
                        if (!response.ok) throw new Error(`Fetch failed: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        console.log("updateMap: Locations:", data.locations);
                        markers.forEach(marker => marker.map = null);
                        markers = [];
                        data.locations.forEach(loc => {
                            if (loc.active) {
                                if (loc.name === creatorName) {
                                    const marker = new google.maps.marker.AdvancedMarkerElement({
                                        position: { lat: loc.lat, lng: loc.lng },
                                        map: map,
                                        title: loc.name,
                                        content: buildStandardPinContent(loc.name)
                                    });
                                    markers.push(marker);
                                } else {
                                    const marker = new google.maps.marker.AdvancedMarkerElement({
                                        position: { lat: loc.lat, lng: loc.lng },
                                        map: map,
                                        title: loc.name,
                                        content: buildMarkerContent(loc.name)
                                    });
                                    markers.push(marker);
                                }
                            }
                        });
                        if (markers.length > 1) {
                            const bounds = new google.maps.LatLngBounds();
                            markers.forEach(marker => bounds.extend(marker.position));
                            map.fitBounds(bounds);
                        }
                    })
                    .catch(error => console.error("updateMap: Error:", error.message));
            }

            function buildStandardPinContent(name) {
                const pin = new google.maps.marker.PinElement({
                    background: '#FF0000',
                    borderColor: '#000000',
                    glyphColor: '#FFFFFF'
                });
                const div = document.createElement('div');
                div.style.textAlign = 'center';
                div.appendChild(pin.element);
                const label = document.createElement('div');
                label.textContent = name;
                label.style.color = '#000';
                label.style.fontSize = '12px';
                label.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
                label.style.padding = '2px 4px';
                label.style.borderRadius = '2px';
                div.appendChild(label);
                return div;
            }

            function buildMarkerContent(name) {
                const img = document.createElement('img');
                img.src = 'https://rubingosaliya.github.io/location-share-test/favicon.ico';
                img.style.width = '32px';
                img.style.height = '32px';
                const div = document.createElement('div');
                div.style.textAlign = 'center';
                div.appendChild(img);
                const label = document.createElement('div');
                label.textContent = name;
                label.style.color = '#000';
                label.style.fontSize = '12px';
                div.appendChild(label);
                return div;
            }

            setMapToUserLocation();
            sendLocation();
            updateMap();
            setInterval(sendLocation, 10000);
            setInterval(updateMap, 10000);
        }
    </script>
</body>
</html>