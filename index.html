<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Share</title>
    <script async src="https://maps.google.com/maps/api/js?key=YOUR_API_KEY&callback=initMap"></script>
    <style>
        #map { height: 400px; width: 100%; }
        .faded { opacity: 0.5; }
    </style>
</head>
<body>
    <h1>Location Share</h1>
    <button id="createEvent">Create Event Link</button>
    <button id="stopSharing">Stop Sharing</button>
    <div id="map"></div>
    
    <script>
        let map, userMarker, sessionId, userName, shareUntil;
        let markers = {};
        
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 0, lng: 0 },
                zoom: 2
            });
            
            document.getElementById('createEvent').addEventListener('click', createEvent);
            document.getElementById('stopSharing').addEventListener('click', stopSharing);
            
            startLocationSharing();
        }
        
        function createEvent() {
            const duration = prompt("Enter event duration in hours (max 6):");
            if (duration > 0 && duration <= 6) {
                fetch(`/createEvent?duration=${duration}`)
                    .then(res => res.json())
                    .then(data => alert(`Share this link: ${window.location.origin}/?session=${data.sessionId}`));
            }
        }
        
        function startLocationSharing() {
            sessionId = new URLSearchParams(window.location.search).get('session');
            if (!sessionId) return alert("No session found!");
            
            userName = prompt("Enter your name:") || "Anonymous";
            shareUntil = Date.now() + (parseInt(prompt("How many hours to share your location? (max 6)") || 1) * 3600000);
            
            navigator.geolocation.watchPosition(updateLocation, console.error, { enableHighAccuracy: true });
            setInterval(fetchLocations, 5000);
        }
        
        function updateLocation(position) {
            const { latitude: lat, longitude: lng, accuracy } = position.coords;
            if (accuracy > 50) return;
            
            fetch(`/updateLocation`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sessionId, lat, lng, userName, shareUntil })
            });
        }
        
        function fetchLocations() {
            fetch(`/getLocations?sessionId=${sessionId}`)
                .then(res => res.json())
                .then(data => {
                    Object.values(markers).forEach(marker => marker.setMap(null));
                    markers = {};
                    
                    data.locations.forEach(({ lat, lng, name, active, isCreator }) => {
                        markers[name] = new google.maps.Marker({
                            position: { lat, lng },
                            map,
                            label: name,
                            icon: isCreator ? { url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png' } : (active ? null : { url: 'http://maps.google.com/mapfiles/ms/icons/grey-dot.png' })
                        });
                    });
                });
        }
        
        function stopSharing() {
            fetch(`/stopSharing?sessionId=${sessionId}`);
            alert("You have stopped sharing your location.");
        }
    </script>
</body>
</html>

