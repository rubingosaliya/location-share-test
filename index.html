<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Share</title>
    <script async src="https://maps.google.com/maps/api/js?key=AIzaSyCtk-cv518k28_YbwytXpeu3-DAg92mAA4&callback=initMap"></script>

    <style>
        #map {
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body>
    <h1>Location Share</h1>
    <div id="map"></div>

    <script>
        let map;
        let userMarker;
        let lastSentLat = null;
        let lastSentLng = null;
        const ACCURACY_THRESHOLD = 100; // Increased threshold for better usability

        function initMap() {
            console.log("initMap started");

            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session');
            if (!sessionId) {
                alert("Please provide a session ID in the URL, e.g., ?session=abc123");
                return;
            }
            console.log("Session ID found: " + sessionId);

            let userName = prompt("Please enter your name:") || "Anonymous";
            console.log("User entered name:", userName);

            // Initialize map with a wider view
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 0, lng: 0 },
                zoom: 2
            });

            function updateUserLocation() {
                if (navigator.geolocation) {
                    console.log("Requesting user location...");
                    navigator.geolocation.watchPosition(
                        (position) => {
                            const { latitude: lat, longitude: lng, accuracy } = position.coords;
                            console.log(`Location update: lat=${lat}, lng=${lng}, accuracy=${accuracy}m`);

                            if (!userMarker) {
                                userMarker = new google.maps.Marker({
                                    position: { lat, lng },
                                    map,
                                    label: userName,
                                });
                                map.setCenter({ lat, lng });
                                map.setZoom(15);
                                console.log("Initial map centering and zooming.");
                            } else {
                                userMarker.setPosition({ lat, lng });
                            }

                            if (accuracy > ACCURACY_THRESHOLD) {
                                console.warn("Location accuracy is too low, but updating UI.");
                                return; // Don't send data if accuracy is too low
                            }

                            if (
                                lastSentLat !== null &&
                                lastSentLng !== null &&
                                Math.abs(lat - lastSentLat) < 0.0001 &&
                                Math.abs(lng - lastSentLng) < 0.0001
                            ) {
                                console.log("Location has not changed significantly, skipping POST.");
                                return;
                            }

                            lastSentLat = lat;
                            lastSentLng = lng;

                            console.log("Sending location update...");
                            fetch(`https://location-share-backend-rubin-gosaliyas-projects.vercel.app/locations/${sessionId}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ lat, lng, name: userName }),
                            })
                                .then((response) => response.text())
                                .then((data) => console.log("POST response:", data))
                                .catch((error) => console.error("POST error:", error));
                        },
                        (error) => console.error("Error getting location:", error),
                        { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
                    );
                } else {
                    alert("Geolocation is not supported by this browser.");
                }
            }

            function updateMap() {
                fetch(`https://location-share-backend-rubin-gosaliyas-projects.vercel.app/locations/${sessionId}`)
                    .then((response) => response.json())
                    .then((data) => {
                        console.log("Fetched locations:", JSON.stringify(data.locations, null, 2));

                        data.locations.forEach((loc) => {
                            new google.maps.Marker({
                                position: { lat: loc.lat, lng: loc.lng },
                                map,
                                label: loc.name || "Unnamed",
                            });
                        });
                    })
                    .catch((error) => console.error("Error fetching locations:", error));
            }

            updateUserLocation();
            setInterval(updateMap, 5000);
        }
    </script>
</body>
</html>

