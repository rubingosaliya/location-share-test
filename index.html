<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Share</title>
    <!-- Replace 'YOUR_API_KEY' with your actual Google Maps API key -->
    <script async src="https://maps.google.com/maps/api/js?key=AIzaSyCtk-cv518k28_YbwytXpeu3-DAg92mAA4&callback=initMap"></script>

    <style>
        #map {
            height: 400px; /* Set the height of the map */
            width: 100%;   /* Set the width of the map */
        }
    </style>
</head>
<body>
    <h1>Location Share</h1>
    <div id="map"></div>

    <script>
        function initMap() {
            console.log("initMap started");

            // Get session ID from URL params
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session');
            if (!sessionId) {
                alert("Please provide a session ID in the URL, e.g., ?session=abc123");
                return;
            }
            console.log("Session ID found: " + sessionId);

            // Prompt for user name
            let userName = prompt("Please enter your name:");
            if (!userName) {
                userName = "Anonymous";
                console.log("No name entered, defaulting to Anonymous");
            } else {
                console.log("User entered name: " + userName);
            }

            // Initialize map centered on a default location
            var map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 0, lng: 0 },
                zoom: 2
            });
            console.log("Map initialized successfully");

            // Set the map to the user's current location with improved accuracy
            function setMapToUserLocation() {
                if (navigator.geolocation) {
                    console.log("Requesting user location...");
                    navigator.geolocation.getCurrentPosition(function(position) {
                        var userLat = position.coords.latitude;
                        var userLng = position.coords.longitude;
                        var accuracy = position.coords.accuracy; // Get accuracy

                        console.log("User location: lat=" + userLat + ", lng=" + userLng + ", accuracy=" + accuracy + " meters");

                        // Only center the map if the accuracy is within an acceptable range
                        if (accuracy <= 30) {  // Accuracy threshold of 30 meters
                            map.setCenter({ lat: userLat, lng: userLng });
                            map.setZoom(15);
                            console.log("Map zoomed to user location with high accuracy");
                        } else {
                            console.log("Location accuracy is too low, not updating map.");
                        }
                    }, function(error) {
                        console.error("Error getting user location:", error);
                    }, {
                        enableHighAccuracy: true, // High accuracy setting
                        timeout: 5000,             // Timeout after 5 seconds
                        maximumAge: 0              // Don't use cached location
                    });
                } else {
                    console.log("Geolocation not supported by this browser");
                }
            }

            // Send location data to the backend
            let lastSentLat = null;
            let lastSentLng = null;

            function sendLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;

                        // Get the accuracy of the current location
                        const accuracy = position.coords.accuracy;

                        // Check if location has changed significantly and accuracy is acceptable
                        if (lastSentLat !== null && lastSentLng !== null &&
                            Math.abs(lat - lastSentLat) < 0.0001 && Math.abs(lng - lastSentLng) < 0.0001) {
                            console.log("Location has not changed significantly, skipping POST");
                            return; // Do not send location if it hasn't changed significantly
                        }

                        // Only send location if accuracy is within acceptable range (30 meters)
                        if (accuracy <= 30) {
                            // Update the last sent location
                            lastSentLat = lat;
                            lastSentLng = lng;

                            console.log("Sending location with name: " + userName);
                            fetch(`https://location-share-backend-rubin-gosaliyas-projects.vercel.app/locations/${sessionId}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ lat, lng, name: userName })
                            })
                            .then(response => response.text())
                            .then(data => console.log("POST response:", data))
                            .catch(error => console.error("POST error:", error));
                        } else {
                            console.log("Location accuracy is too low, skipping POST.");
                        }
                    }, function(error) {
                        console.error("Error getting location:", error);
                    }, {
                        enableHighAccuracy: true, // High accuracy setting
                        timeout: 5000,             // Timeout after 5 seconds
                        maximumAge: 0              // Don't use cached location
                    });
                } else {
                    alert("Geolocation is not supported by this browser.");
                }
            }

            var markers = [];

            // Update the map with locations from the backend
            function updateMap() {
                fetch(`https://location-share-backend-rubin-gosaliyas-projects.vercel.app/locations/${sessionId}`, {
                    method: 'GET'
                })
                .then(response => response.json())
                .then(data => {
                    // Clear existing markers
                    markers.forEach(marker => marker.setMap(null));
                    markers = [];

                    console.log("Fetched locations:", JSON.stringify(data.locations, null, 2));

                    // Check if the location has a name
                    data.locations.forEach(loc => {
                        console.log("Location data:", loc); // Log individual location object
                        var marker = new google.maps.Marker({
                            position: { lat: loc.lat, lng: loc.lng },
                            map: map,
                            label: loc.name ? loc.name : "Unnamed"  // This should correctly display the name if available
                        });
                        markers.push(marker);
                    });
                })
                .catch(error => console.error("Error fetching locations:", error));
            }

            // Call functions to set location, send, and update map
            setMapToUserLocation();
            sendLocation();
            updateMap();

            // Update every 5 seconds
            setInterval(sendLocation, 5000);
            setInterval(updateMap, 5000);
        }
    </script>
</body>
</html>

